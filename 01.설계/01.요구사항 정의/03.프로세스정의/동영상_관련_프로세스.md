# 동영상 프로세스

이 문서는 **라이브 방송 녹화 및 크리에이터 업로드 비디오**의 저장, 변환, 관리에 대한 프로세스를 설명한다.  
라이브 스트리밍과 관련된 실시간 방송 프로세스는 **"방송 관련 프로세스" 문서에서 관리**한다.

---

## 1. 비디오 저장 및 경로 구조

### 1.1 비디오 저장 경로
비디오는 **S3에 HLS 포맷으로 저장**되며, **비디오 ID 기준으로 관리**된다.

- **저장 경로 구조:**  
```
s3://videos/abcd1234/720p/index.m3u8
```

### 1.2 오브젝트 저장소 계층화
비디오 파일은 **오브젝트 저장소(S3) 1, 2, 3**으로 순차적으로 저장된다. 각 저장소는 다음과 같은 역할을 수행한다.
- **오브젝트 저장소 1:** 원본 업로드 저장소
- **오브젝트 저장소 2:** 트랜스코딩 중간 저장소
- **오브젝트 저장소 3:** 최종 HLS 패키징된 저장소

파일 업로드 시 **프론트엔드에서 오브젝트 저장소 1(S3)의 Signed URL을 반환받아 직접 업로드**하며, 크리에이터가 직접 URL을 입력하지 않고 **프론트엔드가 Signed URL을 통해 자동으로 업로드를 처리**한다. **보안정책 필요**

## 2. 비디오 생성 프로세스

### 2.1 **라이브 방송 녹화 (다시보기 생성)**
1. **스트리머가 라이브 방송을 시작하면 방송 엔티티가 생성됨.**  
2. 방송이 진행되면서 **RTMP-to-HLS 변환이 실시간으로 이루어짐**  
3. **녹화가 시작되면 Video 엔티티가 생성됨 (`status = RECORDING`)**  
4. 방송이 종료되면 **HLS 파일이 S3에 저장되고 Video 상태가 `COMPLETED`로 변경됨**  

---

### 2.2 **크리에이터 업로드 비디오**
1. **파일이 업로드되면 Video 엔티티가 생성됨 (`status = UPLOADED`)**  
2. **파일 업로드 서비스 → 오브젝트 저장소 1에 업로드 (`status = UPLOADED`)**  
3. **트랜스코딩 서비스가 오브젝트 저장소 1에서 파일을 가져와 변환 후 오브젝트 저장소 2에 저장 (`status = TRANSCODING`)**  
4. **패키징 서비스가 오브젝트 저장소 2에서 변환된 파일을 가져와 HLS 패키징 후 오브젝트 저장소 3에 저장 (`status = PACKAGING`)**  
5. **모든 변환이 완료되면 Video 상태가 `COMPLETED`로 변경됨**  
6. **이메일 서비스에서 업로드 성공/실패를 크리에이터에게 알림**  

📌 **트랜스코딩/패키징 단계에서 3회 실패 시 `FAILED` 처리됨.**  

---

## 3. 비디오 상태 관리

비디오의 상태는 **각 처리 단계마다 비동기 이벤트를 통해 변경됨.**  

| 상태 | 설명 |
|------|------|
| `UPLOADED` | 크리에이터가 비디오를 업로드함 |
| `RECORDING` | 라이브 방송을 녹화 중 |
| `TRANSCODING` | 트랜스코딩 진행 중 |
| `PACKAGING` | DRM 및 HLS 변환 진행 중 |
| `COMPLETED` | 변환 완료 및 스트리밍 가능 |
| `FAILED` | 변환 실패 (3회 이상 오류 발생) |

---

## 4. 비디오 시청 및 화질 변경 프로세스

### 4.1 **다시보기/VOD 시청 흐름**
1. 시청자가 **비디오 플레이어를 통해 기본 화질(예: 720p)로 서버에 요청**  
2. 서버는 **해당 비디오 ID에 대한 S3 URL을 반환**  
```
요청: { "videoId": "abcd1234", "resolution": "720" } 응답: { "url": "s3://videos/abcd1234/720p/index.m3u8" }
```

3. 플레이어가 **해당 URL을 로드하여 스트리밍 시작**  

---

### 4.2 **화질 변경 시 흐름**
1. 사용자가 **다른 화질(예: 480p)로 변경 요청**  
2. 서버는 해당 `videoId`에 대한 새로운 URL을 제공  
```
요청: { "videoId": "abcd1234", "resolution": "480" } 응답: { "url": "s3://videos/abcd1234/480p/index.m3u8" }
```

3. 플레이어가 **새로운 URL을 로드하여 화질 변경**  

---

## 5. 엔티티 구조

### 5.1 **비디오 엔티티 (Video)**
비디오의 기본 정보를 저장하며, 다시보기 영상과 업로드 영상을 포함한다.

| 컬럼명 | 타입 | 설명 |
|------|------|------|
| `videoId` | UUID | 비디오 고유 ID |
| `streamerId` | UUID | 스트리머(업로더) ID |
| `channelId` | UUID | 채널 ID |
| `title` | String | 비디오 제목 |
| `videoType` | ENUM(`LIVE_REPLAY`, `UPLOAD`) | 비디오 유형 (다시보기 / 업로드) |
| `status` | ENUM(`RECORDING`, `TRANSCODING`, `PACKAGING`, `COMPLETED`, `FAILED`) | 비디오 상태 |
| `basePath` | STRING | S3에 저장된 기본 경로 |
| `createdAt` | TIMESTAMP | 생성 시간 |
| `updatedAt` | TIMESTAMP | 마지막 변경 시간 |

📌 **화질별 개별 URL을 저장하지 않고, `basePath`만 저장하여 프론트엔드에서 요청하는 화질을 조합하여 URL을 생성함.**

