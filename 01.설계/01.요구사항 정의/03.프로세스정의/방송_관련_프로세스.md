# 방송 운영 및 시청 흐름

## 1. 스트리머가 방송을 시작하는 과정
1. 스트리머가 OBS Studio에서 phzzk RTMP-to-HLS 서비스 주소와 자신의 스트림 키를 설정한다.
2. OBS에서 방송을 시작하면 RTMP-to-HLS 서버(Nginx RTMP 모듈)가 RTMP 스트림을 수신한다.
3. RTMP-to-HLS 서버는 처음 방송을 시작할 때 스트림 키를 라이브스트림서비스로 전달한다.
4. 라이브스트림서비스는 스트림 키를 검증한 후, 유저서비스에서 유저 정보를 조회하여 해당 스트림 키의 유저를 확인하고 isLive가 true인 방송 데이터를 생성한다.
5. 동일한 채널에서 여러 개의 방송이 동시에 실행되지 않도록 제한한다.

## 2. 스트리머가 방송을 관리하는 과정
1. 스트리머가 "방송하기" 웹화면으로 이동하면 방송 설정 폼, 채팅 창, 비디오 재생 영역을 확인할 수 있다.
2. 방송하기 버튼은 제공되지 않으며, 설정 변경을 위한 업데이트 버튼이 있다.
3. 업데이트 버튼을 누르면 방송 설정 폼의 설정이 즉시 반영된다.
4. 스트리머가 처음 방송하기 웹화면에 입장하면(즉, 이전에 방송을 하지 않고 처음 방송을 시작하는 경우) 기본값으로 `{닉네임}의 방송` 등의 설정이 적용된다.
5. OBS에서 방송을 종료한 후 다시 방송을 시작하면 지난 방송의 설정이 그대로 적용되며, UI에서도 이전 방송 설정이 남아 있다.
6. 동일한 방송 설정이 여러 번 적용되는 것을 방지하기 위해, 방송 시작 시 기존 방송 데이터를 참조하여 새 방송이 생성되지 않도록 한다.

## 3. 방송 진행 과정
### 방송 시작
1. OBS에서 RTMP 스트림을 송출한다.
2. RTMP-to-HLS 서버가 RTMP를 수신하여 HLS 포맷으로 변환한다.
3. RTMP-to-HLS 서버는 처음 방송을 시작할 때 스트림 키를 라이브스트림서비스로 전달한다.
4. 라이브스트림서비스에서 해당 스트림 키를 확인하고 방송 상태를 isLive: true로 변경한다.

### 방송 종료
1. OBS에서 방송을 종료하면 RTMP-to-HLS 서버가 스트림을 중단한다.
2. OBS가 일정 시간 동안 응답이 없거나, 스트리머가 OBS에서 설정한 화질이 허용된 최대치를 초과한 경우 RTMP-to-HLS 서버는 방송을 강제 종료하고 해당 스트리머에게 오류 메시지를 전송한다.
3. 라이브스트림서비스에서 해당 스트림의 상태를 isLive: false로 변경한다.

## 4. 방송 녹화 및 저장 과정
1. OBS에서 RTMP 스트림을 송출하면 RTMP-to-HLS 서버가 HLS 파일을 생성한다.
2. RTMP-to-HLS 서버에서 직접 S3 저장소에 업로드한다.
3. 라이브스트림서비스는 저장된 HLS 파일의 URL만 관리하며, 이를 기반으로 녹화된 영상을 제공한다. 
4. 방송이 종료되면 저장된 HLS 파일을 기반으로 VOD를 생성한다.

## 5. HLS 파일 저장 방식
S3 저장소에 `S3/채널명/화질/*.m3u8` 구조로 저장된다.
