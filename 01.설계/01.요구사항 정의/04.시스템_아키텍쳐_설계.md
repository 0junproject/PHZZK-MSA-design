# PHZZK 시스템 아키텍처 및 설계 문서

## 1. 개요
PHZZK는 실시간 비디오 스트리밍 플랫폼으로, MSA(Microservices Architecture)를 기반으로 설계된다. 본 문서는 시스템의 전체 구조, 인증 및 보안, 서비스 간 통신 방식, 캐싱 전략, 서비스 디스커버리 및 설정 관리 등을 포함하여 상세한 설계를 문서화한 것이다.

---

## 2. 전체 시스템 구조
PHZZK의 전체 시스템은 **Spring Cloud 기반 MSA**로 구성되며, 주요 서비스는 다음과 같다:

- **Frontend**: Next.js 기반 웹서버
- **RTMP-to-HLS 서버**: 라이브 스트림을 HLS로 변환하는 서버
- **트랜스코딩 서비스**: 동영상 트랜스코딩을 담당하는 서비스
- **패키징 서비스**: VOD 파일을 패키징하는 서비스
- **API Gateway**: 인증 및 요청 라우팅 담당 (JWT 인증 포함)
- **Spring Cloud Config 서비스**: 설정 관리를 담당하는 서비스
- **Discovery 서비스 (Eureka)**: 서비스 등록 및 탐색을 담당
- **이벤트 버스**: Kafka를 이용한 이벤트 기반 메시지 시스템
- **캐싱 서비스**: Redis 기반의 데이터 캐싱 (채팅참여정보, 채팅메시지, 방송 통계 등)

각 서비스 간 통신은 **Kafka 이벤트 기반의 비동기 방식**과 **REST API 기반의 동기 방식**을 병행하여 활용한다.

API Gateway를 통해 외부에서 직접 접근할 수 없는 서비스들을 보호하며, 동적으로 할당된 서비스 포트도 문제없이 연결 가능하도록 설계된다.

---

## 3. 캐싱 서비스 설계
**기존의 채팅참여캐싱서비스를 확장하여 "캐싱 서비스"로 개선**

- **목적**: 채팅 참여자 정보를 빠르게 조회하고, 실시간 채팅 데이터 및 방송 관련 정보를 효율적으로 관리하기 위함
- **주요 기능**:
  - 채팅 참여자 정보 캐싱
  - 채팅 메시지 캐싱
  - 방송 통계 및 트래픽 데이터 캐싱
  - Redis를 활용하여 빠른 조회 가능
  - Kafka Consumer를 활용하여 DB와 일정 주기로 동기화

이로써 채팅 시스템과 방송 데이터의 부하를 줄이고, 실시간 성능을 개선할 수 있다.

---

## 4. 인증 및 보안
**JWT 기반 인증 + API Gateway의 인증 검증 역할 개선**

- **JWT 발급 및 관리**:
  - 로그인 시 유저 서비스에서 **JWT(Access Token, Refresh Token)를 발급**
  - API Gateway는 모든 요청에서 JWT 유효성을 검사
  - Refresh Token은 Redis 등에 저장하여 별도 인증 서비스(Auth Service)에서 검증 후 재발급

- **소셜 로그인**:
  - 유저가 소셜 로그인 성공 시, 연동된 이메일이 존재하면 로그인
  - 연동 이메일이 없으면 회원가입 진행 (이메일, 닉네임, 비밀번호 필수 입력)
  - 소셜 로그인으로 가입한 경우, 이메일 수정 불가

---

## 5. Discovery Service (Netflix Eureka)
- 각 서비스는 **동적으로 포트 할당**하여 실행되며, Eureka를 통해 등록 및 탐색됨.
- **단점**: Eureka의 기본 리프레시 주기가 30초로, 장애 복구 속도가 느릴 수 있음.
- **대안 고려**: 필요시 **Consul 또는 Kubernetes Service Discovery로 전환 가능**

---

## 6. Config Service 및 설정 관리
- **Spring Cloud Config + Git 기반**
- 비공개 Git 저장소를 풀링하여 설정을 관리하며, 변경 사항 발생 시 **RabbitMQ 또는 Kafka를 이용하여 다른 서비스로 전파**
- **보안 강화**: 민감한 설정값(DB 패스워드, API Key 등)은 **Vault 또는 암호화된 환경변수로 관리**

---

## 7. 최종 정리 및 개선 사항
- 기존의 **채팅참여캐싱서비스를 캐싱서비스로 확장**하여 다양한 실시간 데이터 관리 가능
- **JWT 검증 부하를 API Gateway에서 별도 Auth Service로 분리**하여 확장성 확보
- **Eureka 장애 복구 속도를 고려하여 Kubernetes Service Discovery 도입 검토**
- **Config 변경 이벤트 전달에 Kafka 활용 검토**하여 확장성 강화

이러한 개선점을 반영하여, PHZZK 시스템은 더욱 확장성 있고 안정적인 구조를 가질 수 있도록 설계되었다.

